<div class="container">
  <div class="tag-list">
    <p><i class="fas fa-hashtag"></i>タグで探す</p>
    <% @tags.each do |tag| %>
      <span class="pr-1">
        <%= link_to tag.name, tag_search_path(tag_id: tag.id) %><%="(#{tag.posts.count}) " %>
      </span>
    <%end%>
  </div>
  
  <h2>All POSTS</h2>
  
    <%= render "post_index", posts: @posts %>
    <div class="my-5 ml-auto">
      <%= paginate(@posts) %>
    </div>
  
  
  <h2>MAP</h2>
  
  <!--検索フォーム-->
  <input id="address" type="textbox" value="大阪">
  <input type="button" value="検索" onclick="codeAddress()" class="btn btn-secondary btn-sm">
  
  <div id='map' style='width: 100%; height: 500px;' class="mt-3"></div>
  
</div>


<script>
  let map

  function initMap(){
    // geocoderを初期化
    geocoder = new google.maps.Geocoder()

    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 35.68123620000001, lng:139.7671248},
        zoom: 7,
    });


    <% @posts.each do |post| %>
        (function(){
        var contentString = "住所：<%= post.address %>";

        var marker = new google.maps.Marker({
            position:{lat: <%= post.latitude %>, lng: <%= post.longitude %>},
            map: map,
            title: contentString
        });

      })();
    <% end %>
    }

    let geocoder

    function codeAddress(){
      let inputAddress = document.getElementById('address').value;

      geocoder.geocode( { 'address': inputAddress}, function(results, status) {
        if (status == 'OK') {
          map.setCenter(results[0].geometry.location);
        } else {
          alert('該当する結果がありませんでした：' + status);
        }
      });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['API_KEY'] %>&callback=initMap" async defer></script>
